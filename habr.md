# Генерация рабочей календарной таблицы с помощью WorkingCalendar

## Зачем нужен производственный календарь

В повседневной работе многих компаний важно учитывать рабочие и выходные дни — от расчета зарплат до планирования маркетинговых акций. В типичном корпоративном приложении часто приходится высчитывать количество рабочих дней между датами, учитывать короткие недели или переносы праздников. Удобно хранить такую информацию в отдельной таблице базы данных. Репозиторий WorkingCalendar предлагает готовое решение для PostgreSQL, MySQL и MSSQL, а на сайте workingcalendar.ru можно сгенерировать SQL-скрипт буквально в пару кликов.

В таблице `WorkingCalendar` хранятся даты и флаг, показывающий, рабочий ли это день. Автор отмечает, что такая таблица пригодится для планирования отпусков, расчета зарплаты, маркетинга или распределения ресурсов — ведь многие бизнес-процессы зависят от календаря праздников и выходных.

## Источники данных и структура проекта

Проект использует официальный XML-календарь из репозитория xmlcalendar/data. Данные за 2013–2023 годы лежат в папке `WorkingCalendar.Server/Data` и копируются из upstream-репозитория. Когда выйдут данные за новые годы, их можно обновить простой командой `git pull` и заменой папок для стран вроде ru, kz, by, ua, uz. Автор напоминает, что календарь принадлежит xmlcalendar.ru, и нужно соблюдать их лицензию.

Проект разделен на слои для удобства:

- **WorkingCalendar.Domain** — здесь доменная модель и логика расчета рабочих/выходных дней. Класс `Calendar` парсит XML, определяет тип дня (рабочий, выходной или праздник) и генерирует SQL.
- **WorkingCalendar.Application** — слой сервисов. `CalendarService` имеет метод `GetYearSqlAsync`, который создает SQL-скрипт для указанного года, типа БД и количества рабочих дней в неделе. Если передать `all` в параметр `year`, сервис соберет скрипты для всех доступных календарей.
- **WorkingCalendar.Server** — API на ASP.NET Core. Контроллер `WorkingCalendarController` предлагает метод `GetYearWorkingCalendar`, который принимает год, тип БД (mssql/mysql/postgresql) и дни в неделе, а возвращает готовый SQL-текст.
- **workingcalendar.client** — фронтенд на React. Сайт workingcalendar.ru позволяет выбрать год, тип БД, рабочую неделю (5 или 6 дней) и получить скрипт. Там же можно переключать тему, язык и просматривать календарь.

Для локального запуска подойдет порт 8080, Docker или Helm. В Helm-чарте есть post-install hook, который выполнит SQL-скрипт для создания таблицы и вставки данных.

## Как формируется SQL-скрипт

Крутая фишка проекта — генерация SQL на лету. Метод `Calendar.GenerateSql` в доменной модели принимает год, тип БД и число рабочих дней. В зависимости от СУБД он создает таблицу так:

```csharp
switch (type)
{
    case "mssql":
        builder.Append("CREATE TABLE WorkingCalendar (id bigint IDENTITY NOT NULL, DateDay date NOT NULL, IsWorkingDay bit NOT NULL);");
        break;
    case "mysql":
        builder.Append("CREATE TABLE WorkingCalendar (  id INTEGER PRIMARY KEY AUTO_INCREMENT,  DateDay DATE NOT NULL,  IsWorkingDay BIT NOT NULL);");
        break;
    case "postgresql":
        builder.Append("CREATE TABLE WorkingCalendar (id SERIAL PRIMARY KEY, DateDay date NOT NULL, IsWorkingDay bit NOT NULL);");
        break;
}
```

Затем он перебирает все даты года, определяет тип дня и формирует один большой `INSERT INTO WorkingCalendar` со списком значений. Для PostgreSQL флаг рабочего дня в кавычках ('1' или '0'), для других — без. Скрипт начинается с `CREATE TABLE` и заканчивается точкой с запятой. Вот пример для 2025 года в PostgreSQL:

```sql
CREATE TABLE WorkingCalendar (id SERIAL PRIMARY KEY, DateDay date NOT NULL, IsWorkingDay bit NOT NULL);

INSERT INTO WorkingCalendar (DateDay, IsWorkingDay) VALUES
('2025-01-01', '0'),
('2025-01-02', '0'),
('2025-01-03', '0'),
…
('2025-12-31', '1');
```

Если выбрать 6-дневную неделю, расчет дней меняется, но подход тот же. Такой скрипт подойдет и для новой БД, и для обновления существующей. В API можно генерировать скрипты за все годы сразу — метод просто склеит их в один текст.

## Использование API и веб-сайта

Чтобы получить скрипт, вызовите GET `/WorkingCalendar/GetYearWorkingCalendar` с параметрами:

- `year` — год или `all` для всех годов;
- `type` — тип БД (mssql, mysql, postgresql);
- `days` — рабочие дни в неделе (5 или 6).

Контроллер вернет SQL-строку. Сайт workingcalendar.ru работает так же: выбираешь параметры, жмешь кнопку — и вот скрипт в текстовой области, готовый к копированию. Плюс там календарь на год, переключатель тем и описание таблицы.

## Развёртывание и обновление

Для развертывания есть Helm-чарт: его hook создаст PostgreSQL и запустит Job с скриптом из ConfigMap. Для проверки миграций — скрипт `scripts/check-migrations.sh`, который поднимет временную БД и применит изменения. В Docker укажите `ASPNETCORE_URLS=http://localhost:8080` или `ASPNETCORE_HTTP_PORT=8080`.

Обновление данных просто: скачайте свежие XML из XMLCalendar, замените папки и перегенерируйте скрипт. Не забудьте про лицензию — укажите источник от xmlcalendar.ru.

## Заключение

WorkingCalendar и сайт workingcalendar.ru — это удобный способ автоматизировать создание и обновление производственного календаря в БД. В отличие от общих советов в статьях, здесь полноценный API и генератор SQL. Выбери год, БД и неделю — и получи готовый скрипт для таблицы и данных. Благодаря официальным данным, поддержке разных СУБД и простому обновлению, это решение подойдет для старта или регулярного апдейта.